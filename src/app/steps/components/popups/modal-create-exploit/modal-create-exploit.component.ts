import { Component, Inject } from '@angular/core';
import { MAT_DIALOG_DATA, MatDialogRef } from '@angular/material/dialog';
import { STEPService } from 'src/app/core/services/step.service';

@Component({
  selector: 'app-modal-create-exploit',
  templateUrl: './modal-create-exploit.component.html',
  styleUrls: ['./modal-create-exploit.component.scss']
})
export class ModalCreateExploitComponent {

  public nom: string = "";
  public telephoneFixe: string = "";
  public telephoneMobile: string = "";
  public email: string = "";
  public fonction: string = "";

  public errorMessage: string = '';

  constructor(private stepService: STEPService, @Inject(MAT_DIALOG_DATA) public data: any, private dialogRef: MatDialogRef<ModalCreateExploitComponent>) {
  }

  addExploitant(): void {
    const formData = this.getDataForm();


    if (formData) {
      this.stepService.addExploitant(formData).subscribe(() => {
        this.dialogRef.close(true); // Fermer la boîte de dialogue avec un résultat positif
      }
      );
    }
  }

  getDataForm(): any {
    // Validation des données
    if (this.nom.trim() === '') {
      // Mettez à jour la propriété errorMessage avec le message approprié
      this.errorMessage = 'Veuillez vérifier le nom de l\'exploitant.';
      return;
    }

    // Réinitialisez errorMessage s'il n'y a pas d'erreur
    this.errorMessage = '';

    const formData = new FormData();

    formData.append('exploitantsCount', this.data.exploitantsCount.toString());
    formData.append('idClient', this.data.idClient);
    formData.append('nom', this.escapeString(this.nom));
    formData.append('telephoneFixe', this.telephoneFixe);
    formData.append('telephoneMobile', this.telephoneMobile);
    formData.append('email', this.email);
    formData.append('fonction', this.escapeString(this.fonction));

    console.log(formData);

    return formData;
  }

  private escapeString(input: string): string {
    return input.replace(/'/g, "''");
  }

}
